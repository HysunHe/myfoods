<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oracle.oda.ext.dao.FoodsMapper">
	<select id="list" resultType="com.oracle.oda.ext.pojos.GeoJson">
        with x as (SELECT
            t1.pk_col,
            t1.pin_code,
            t1.store_address,
            t1.store_name,
            sdo_nn_distance(5)  distance_m,
            get_geometry(t1.longitude, t1.latitude) geometry
        FROM
            ouser.online_stores t1
        WHERE
                sdo_nn(get_geometry(t1.longitude, t1.latitude),
                    mdsys.sdo_geometry(2001,
                                        4326,
                                        sdo_point_type(#{longitude}, #{latitude}, NULL),
                                        NULL,
                                        NULL),
                    'sdo_batch_size=10 unit=KM',
                    5) = 'TRUE'
                AND ROWNUM <![CDATA[<=]]> 10
            )
        SELECT 'application/json' as mediatype,
            '{"type": "FeatureCollection", "features":'
            || JSON_ARRAYAGG(
                '{"type": "Feature", "properties": {'
                || '"pk_col":"'|| pk_col
                ||'","pin_code":"'|| pin_code
                ||'","store_address":"'|| store_address
                ||'","store_name":"'|| store_name
                ||'","distance_m":"'|| distance_m
                ||'"}, "geometry":'|| SDO_UTIL.TO_GEOJSON(Geometry)
                ||'}'
            FORMAT JSON RETURNING CLOB)
            ||'}'
            AS GEOJSON
        FROM X
	</select>

	<insert id="insertOnlineOrder" parameterType="com.oracle.oda.ext.pojos.OnlineOrder">
		INSERT INTO J_ONLINEORDER
		(
            COUNTRY_CODE,
			ID,
			DATE_LOADED,
			OO_DOCUMENT
		) VALUES (
            #{countryCode},
			#{id},
			#{dt},
			#{json}
		)
	</insert>
	
	<insert id="insertCustomerOrder" parameterType="com.oracle.oda.ext.pojos.CustomerOrder">
		INSERT INTO CUSTOMERORDER
		(
            COUNTRY_CODE,
			NAME,
			PHONE,
			LOCATION,
			CARD
		) VALUES (
			#{countryCode},
			#{name},
			#{phone},
			#{location},
			#{card}
		)
	</insert>
</mapper>